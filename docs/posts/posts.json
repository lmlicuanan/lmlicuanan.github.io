[
  {
    "path": "posts/2022-02-03-demystifying-openstreetmap-data/",
    "title": "Demystifying OpenStreetMap Data",
    "description": "On accessing information from one of the largest repositories of (free) geospatial data.",
    "author": [
      {
        "name": "Lino Licuanan",
        "url": {}
      }
    ],
    "date": "2022-02-03",
    "categories": [
      "draft",
      "data-science",
      "geospatial"
    ],
    "contents": "\n\nContents\nIntroduction\nPrerequisites\nData & PreprocessingSetup\nBounding Box\nOverpass Queries\nsf Objects\nPreprocessing\nPipeline\n\nVisualization\n\n\n\n\nwindow.dataLayer = window.dataLayer || [];\nfunction gtag(){dataLayer.push(arguments);}\ngtag('js', new Date());\n\ngtag('config', 'G-9MHZYW9421');\nIntroduction\nOpenStreetMap is a platform for crowdsourcing geospatial information from basically anywhere volunteers are willing to go. This makes it one of the most powerful databases readily available to the public – contributors have been known to visit locations no single operator can reach (including Google). The database has use cases ranging from mapping far flung communities pre-calamity, to giving your Grab driver the best possible route.\n\n\n{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"http://openstreetmap.org\\\">OpenStreetMap<\\/a> contributors, <a href=\\\"http://creativecommons.org/licenses/by-sa/2.0/\\\">CC-BY-SA<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[12.8797,121.774,null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},null,null,null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[12.8797,12.8797],\"lng\":[121.774,121.774]},\"fitBounds\":[5.58,117.17,18.51,126.54,[]]},\"evals\":[],\"jsHooks\":[]}\nOne I found intriguing was a study conducted by researchers from Thinking Machines Data Science, Inc., where they were able to spatially interpolate poverty incidences across the Philippines with extremely high accuracy, and rivaling state-of-the-art approaches on proprietary data (Tingzon et al. 2018).\nBelow I show just a very lightweight introduction for someone looking to get their feet wet with OpenStreetMap.\nPrerequisites\nI make use of two R frameworks below:\ntidyverse (Wickham et al. 2019) (or dplyr to be specific) for its suitability for data processing.\ntargets (Landau 2021) as a pipeline toolkit for optimizing runtime.\nThis exercise is best suited for someone already having some familiarity with these, but elaborate on core concepts all the same later.\nData & Preprocessing\nSetup\n\n\nsuppressPackageStartupMessages({\n  library(targets)\n  library(tidyverse)\n  library(sf)\n})\n\ntar_unscript()\n\n\n\n\ntar_option_set(packages = c(\"osmdata\", \"tidyverse\", \"sf\"))\nhttr::set_config(httr::config(ssl_verifypeer = FALSE))\nset.seed(2022)\n\nIt is generally advised to reset the requirement to verify certificates to TRUE once done. We disabled this only as a workaround to an existing issue.\nBounding Box\n\ntar_target(study_region.bb, getbb(\"Makati\", format_out = \"polygon\") %>% head(1))\n\nOverpass Queries\n\nlist(\n  tar_target(\n    city.ql, study_region.bb %>% opq() %>% \n      add_osm_feature(key = \"admin_level\", value = \"6\")\n  ),\n  tar_target(\n    boundary.ql, study_region.bb %>% opq() %>% \n      add_osm_feature(key = \"admin_level\", value = \"10\")\n  ),\n  tar_target(\n    road.ql, study_region.bb %>% opq() %>%\n      add_osm_feature(key = \"highway\")\n  ),\n  tar_target(\n    building.ql, study_region.bb %>% opq() %>%\n      add_osm_feature(key = \"building\")\n  ),\n  tar_target(\n    amenity.ql, study_region.bb %>% opq() %>%\n      add_osm_feature(key = \"amenity\")\n  )\n)\n\nsf Objects\n\nlist(\n  tar_target(\n    city.sf, city.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)\n  ),\n  tar_target(\n    boundary.sf, boundary.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)\n  ),\n  tar_target(\n    road.sf, road.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)\n  ),\n  tar_target(\n    building.sf, building.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)\n  ),\n  tar_target(\n    amenity.sf, amenity.ql %>% osmdata_sf()\n  )\n)\n\nPreprocessing\nAmenity Classification\n\nlist(\n  tar_target(\n    amenity_point.sf, amenity.sf$osm_points %>%\n      transmute(\n        amenity = case_when(\n          amenity == \"bank\" ~ \"bank\",\n          amenity %in% c(\"restaurant\", \"fast_food\") ~ \"restaurant\",\n          amenity %in% c(\"bar\", \"pub\", \"gambling\", \"nightclub\", \"casino\") ~ \"bar\",\n          amenity %in% c(\"bus_station\", \"taxi\", \"ferry_terminal\") ~ \"terminal\",\n          amenity %in% c(\"clinic\", \"hospital\", \"doctors\", \"dentist\") ~ \"hc_facility\",\n          amenity == \"pharmacy\" ~ \"pharmacy\",\n          amenity %in% c(\"school\", \"college\") ~ \"school\",\n          amenity == \"place_of_worship\" ~ \"place_of_worship\",\n          TRUE ~ NA_character_\n        ), value = TRUE\n      ) %>% mutate(amenity_key = amenity) %>%\n      filter(!is.na(amenity)) %>% spread(key = amenity_key, value = value, fill = FALSE)\n  )\n)\n\nMonte Carlo Sampling\n\nlist(\n  tar_target(\n    mc_point.sf, st_as_sf(st_sample(city.sf$osm_multipolygons, 22 * 16))\n  ),\n  tar_target(\n    mc_point_params.sf, aggregate(\n      amenity_point.sf,\n      mc_point.sf,\n      FUN = function(x) sum(as.logical(x), na.rm = TRUE),\n      join = function(x, y) st_is_within_distance(x, y, dist = 250)\n    ) %>% filter(!is.na(amenity))\n  )\n)\n\nPipeline\n\n✓ skip target study_region.bb\n✓ skip target amenity.ql\n✓ skip target boundary.ql\n✓ skip target city.ql\n✓ skip target road.ql\n✓ skip target building.ql\n✓ skip target amenity.sf\n✓ skip target boundary.sf\n✓ skip target city.sf\n✓ skip target road.sf\n✓ skip target building.sf\n✓ skip target amenity_point.sf\n✓ skip target mc_point.sf\n✓ skip target mc_point_params.sf\n✓ skip pipeline\n\n{\"x\":{\"nodes\":{\"name\":[\"amenity_point.sf\",\"amenity.ql\",\"amenity.sf\",\"boundary.ql\",\"boundary.sf\",\"building.ql\",\"building.sf\",\"city.ql\",\"city.sf\",\"mc_point_params.sf\",\"mc_point.sf\",\"road.ql\",\"road.sf\",\"study_region.bb\"],\"type\":[\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\",\"stem\"],\"status\":[\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\",\"uptodate\"],\"seconds\":[0.287,3.928,14.312,0.001,71.375,0.002,3621.374,0.002,19.086,1.804,0.983,0.001,466.407,5.968],\"bytes\":[52430,252,565388,259,118965,255,8028241,260,41128,7735,6154,255,1077976,10696],\"branches\":[null,null,null,null,null,null,null,null,null,null,null,null,null,null],\"id\":[\"amenity_point.sf\",\"amenity.ql\",\"amenity.sf\",\"boundary.ql\",\"boundary.sf\",\"building.ql\",\"building.sf\",\"city.ql\",\"city.sf\",\"mc_point_params.sf\",\"mc_point.sf\",\"road.ql\",\"road.sf\",\"study_region.bb\"],\"label\":[\"amenity_point.sf\",\"amenity.ql\",\"amenity.sf\",\"boundary.ql\",\"boundary.sf\",\"building.ql\",\"building.sf\",\"city.ql\",\"city.sf\",\"mc_point_params.sf\",\"mc_point.sf\",\"road.ql\",\"road.sf\",\"study_region.bb\"],\"level\":[4,2,3,2,3,2,3,2,3,5,4,2,3,1],\"color\":[\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\",\"#354823\"],\"shape\":[\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\",\"dot\"]},\"edges\":{\"from\":[\"city.sf\",\"study_region.bb\",\"boundary.ql\",\"study_region.bb\",\"study_region.bb\",\"amenity.sf\",\"study_region.bb\",\"amenity.ql\",\"amenity_point.sf\",\"mc_point.sf\",\"study_region.bb\",\"study_region.bb\",\"building.ql\",\"study_region.bb\",\"city.ql\",\"study_region.bb\",\"road.ql\",\"study_region.bb\"],\"to\":[\"mc_point.sf\",\"amenity.ql\",\"boundary.sf\",\"boundary.sf\",\"city.ql\",\"amenity_point.sf\",\"road.ql\",\"amenity.sf\",\"mc_point_params.sf\",\"mc_point_params.sf\",\"building.ql\",\"boundary.ql\",\"building.sf\",\"building.sf\",\"city.sf\",\"city.sf\",\"road.sf\",\"road.sf\"],\"arrows\":[\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\",\"to\"]},\"nodesToDataframe\":true,\"edgesToDataframe\":true,\"options\":{\"width\":\"100%\",\"height\":\"100%\",\"nodes\":{\"shape\":\"dot\",\"physics\":false},\"manipulation\":{\"enabled\":false},\"edges\":{\"smooth\":{\"type\":\"cubicBezier\",\"forceDirection\":\"horizontal\"}},\"physics\":{\"stabilization\":false},\"layout\":{\"hierarchical\":{\"enabled\":true,\"direction\":\"LR\"}}},\"groups\":null,\"width\":null,\"height\":null,\"idselection\":{\"enabled\":false,\"style\":\"width: 150px; height: 26px\",\"useLabels\":true,\"main\":\"Select by id\"},\"byselection\":{\"enabled\":false,\"style\":\"width: 150px; height: 26px\",\"multiple\":false,\"hideColor\":\"rgba(200,200,200,0.5)\",\"highlight\":false},\"main\":{\"text\":\"\",\"style\":\"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;\"},\"submain\":null,\"footer\":null,\"background\":\"rgba(0, 0, 0, 0)\",\"highlight\":{\"enabled\":true,\"hoverNearest\":false,\"degree\":{\"from\":1,\"to\":1},\"algorithm\":\"hierarchical\",\"hideColor\":\"rgba(200,200,200,0.5)\",\"labelOnly\":true},\"collapse\":{\"enabled\":true,\"fit\":false,\"resetHighlight\":true,\"clusterOptions\":null,\"keepCoord\":true,\"labelSuffix\":\"(cluster)\"},\"legend\":{\"width\":0.2,\"useGroups\":false,\"position\":\"right\",\"ncol\":1,\"stepX\":100,\"stepY\":100,\"zoom\":true,\"nodes\":{\"label\":[\"Up to date\",\"Stem\"],\"color\":[\"#354823\",\"#899DA4\"],\"shape\":[\"dot\",\"dot\"]},\"nodesToDataframe\":true}},\"evals\":[],\"jsHooks\":[]}\nVisualization\n\n\nbuilding.sf <- tar_read(building.sf)\nroad.sf <- tar_read(road.sf)\namenity_point.sf <- tar_read(amenity_point.sf)\nmc_point_params.sf <- tar_read(mc_point_params.sf)\n\nggplot() +\n  geom_sf(data = building.sf$osm_polygons) +\n  geom_sf(data = road.sf$osm_lines) +\n  geom_sf(data = amenity_point.sf %>% filter(!bank),\n          aes(group = amenity, colour = amenity),\n          alpha = 0.8) +\n  geom_sf(data = mc_point_params.sf, aes(alpha = bank, size = bank), col = \"red\") +\n  scale_colour_viridis_d() +\n  labs(\n    title = \"Points of Interest and Bank Density in the City of Makati, Philippines\",\n    caption = \"Bank density measured by counting bank branches within 250-m radius.\"\n  )\n\n\n\n\n\n\n\nLandau, William Michael. 2021. “The Targets R Package: A Dynamic Make-Like Function-Oriented Pipeline Toolkit for Reproducibility and High-Performance Computing.” Journal of Open Source Software 6 (57): 2959. https://doi.org/10.21105/joss.02959.\n\n\nTingzon, Isabelle, Ardie Orden, Stephanie Sy, Vedran Sekara, Ingmar Weber, Masoomali Fatehkia, Manuel Garcia Herranz, and Dohyung Kim. 2018. “Mapping Poverty in the Philippines Using Machine Learning, Satellite Imagery, and Crowd-Sourced Geospatial Information.” GitHub Repository. https://github.com/thinkingmachines/ph-poverty-mapping; Github.\n\n\nWickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. “Welcome to the tidyverse.” Journal of Open Source Software 4 (43): 1686. https://doi.org/10.21105/joss.01686.\n\n\n\n\n",
    "preview": "posts/2022-02-03-demystifying-openstreetmap-data/makati.png",
    "last_modified": "2022-02-04T19:23:28+08:00",
    "input_file": "demystifying-openstreetmap-data.knit.md"
  }
]
