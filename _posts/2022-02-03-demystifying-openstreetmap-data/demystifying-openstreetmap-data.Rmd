---
title: "Demystifying OpenStreetMap Data"
description: |
  Suprisingly easy to grab rich information from one of the largest repositories of (free) geospatial data.
author:
  - name: Lino Licuanan
date: 2022-02-03
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_float: true
categories:
  - draft
  - data-science
  - geospatial
preview: makati.png
bibliography: biblio.bib
citation_url: https://lmlicuanan.github.io/posts/2022-02-03-demystifying-openstreetmap-data/
---

# Introduction

OpenStreetMap is a platform for crowdsourcing geospatial information from basically anywhere volunteers are willing to go. This makes it one of the most powerful databases readily available to the public -- contributors have been known to visit locations no single operator can reach (including Google). The database has use cases ranging from mapping far flung communities pre-calamity, to giving your Grab driver the best possible route.

One I found intriguing was a study conducted by researchers from Thinking Machines Data Science, Inc., where they were able to spatially interpolate poverty incidences across the Philippines with extremely high accuracy, and rivaling state-of-the-art approaches on proprietary data [@ph_poverty_prediction_2018].

Below I show just a very lightweight introduction for someone looking to get their feet wet with OpenStreetMap.

# Prerequisites

# Data & Preprocessing

### Setup

```{r}
suppressPackageStartupMessages({
  library(targets)
  library(tidyverse)
  library(sf)  
})

tar_unscript()
```

```{targets globals, tar_globals = TRUE}
tar_option_set(packages = c("osmdata", "tidyverse", "sf"))
httr::set_config(httr::config(ssl_verifypeer = FALSE))
set.seed(2022)
```

<aside>

It is generally advised to reset the requirement to verify certificates to `TRUE` once done. We disabled this only as a workaround to an [existing issue](https://github.com/jeroen/curl/issues/122).

</aside>

### Bounding Box

```{targets study-region}
tar_target(study_region.bb, getbb("Makati", format_out = "polygon") %>% head(1))
```

### Overpass Queries

```{targets osm-queries}
list(
  tar_target(
    city.ql, study_region.bb %>% opq() %>% 
      add_osm_feature(key = "admin_level", value = "6")
  ),
  tar_target(
    boundary.ql, study_region.bb %>% opq() %>% 
      add_osm_feature(key = "admin_level", value = "10")
  ),
  tar_target(
    road.ql, study_region.bb %>% opq() %>%
      add_osm_feature(key = "highway")
  ),
  tar_target(
    building.ql, study_region.bb %>% opq() %>%
      add_osm_feature(key = "building")
  ),
  tar_target(
    amenity.ql, study_region.bb %>% opq() %>%
      add_osm_feature(key = "amenity")
  )
)
```

### `sf` Objects

```{targets osm-data}
list(
  tar_target(
    city.sf, city.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)
  ),
  tar_target(
    boundary.sf, boundary.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)
  ),
  tar_target(
    road.sf, road.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)
  ),
  tar_target(
    building.sf, building.ql %>% osmdata_sf() %>% trim_osmdata(study_region.bb)
  ),
  tar_target(
    amenity.sf, amenity.ql %>% osmdata_sf()
  )
)
```

### Preprocessing

#### Amenity Classification

```{targets osm-data-amenity-point-cleaned}
list(
  tar_target(
    amenity_point.sf, amenity.sf$osm_points %>%
      transmute(
        amenity = case_when(
          amenity == "bank" ~ "bank",
          amenity %in% c("restaurant", "fast_food") ~ "restaurant",
          amenity %in% c("bar", "pub", "gambling", "nightclub", "casino") ~ "bar",
          amenity %in% c("bus_station", "taxi", "ferry_terminal") ~ "terminal",
          amenity %in% c("clinic", "hospital", "doctors", "dentist") ~ "hc_facility",
          amenity == "pharmacy" ~ "pharmacy",
          amenity %in% c("school", "college") ~ "school",
          amenity == "place_of_worship" ~ "place_of_worship",
          TRUE ~ NA_character_
        ), value = TRUE
      ) %>% mutate(amenity_key = amenity) %>%
      filter(!is.na(amenity)) %>% spread(key = amenity_key, value = value, fill = FALSE)
  )
)
```

#### Monte Carlo Sampling

```{targets random-data}
list(
  tar_target(
    mc_point.sf, st_as_sf(st_sample(city.sf$osm_multipolygons, 22 * 16))
  ),
  tar_target(
    mc_point_params.sf, aggregate(
      amenity_point.sf,
      mc_point.sf,
      FUN = function(x) sum(as.logical(x), na.rm = TRUE),
      join = function(x, y) st_is_within_distance(x, y, dist = 250)
    ) %>% filter(!is.na(amenity))
  )
)
```

### Pipeline

```{r, echo=FALSE, message=FALSE}
tar_make()
tar_visnetwork()
```

```{r, include=FALSE}
httr::set_config(httr::config(ssl_verifypeer = TRUE))
```

# Visualization

```{r}
building.sf <- tar_read(building.sf)
road.sf <- tar_read(road.sf)
amenity_point.sf <- tar_read(amenity_point.sf)
mc_point_params.sf <- tar_read(mc_point_params.sf)

ggplot() +
  geom_sf(data = building.sf$osm_polygons) +
  geom_sf(data = road.sf$osm_lines) +
  geom_sf(data = amenity_point.sf %>% filter(!bank),
          aes(group = amenity, colour = amenity),
          alpha = 0.8) +
  geom_sf(data = mc_point_params.sf, aes(alpha = bank, size = bank), col = "red") +
  scale_colour_viridis_d() +
  labs(
    title = "Points of Interest and Bank Density in the City of Makati, Philippines",
    caption = "Bank density measured by counting bank branches within 250-m radius."
  )
```
